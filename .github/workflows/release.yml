name: Release

permissions:
  contents: write
  actions: write

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: true

on:
  workflow_dispatch:
    inputs:
      make_release:
        description: 'Do you want to create a release?'
        required: true
        type: boolean
        default: true
      kernelsu_variant:
        description: "Select KernelSU"
        required: true
        type: choice
        options:
        - Official
        - Next
        - MKSU
        - SukiSU
        default: SukiSU
      kernelsu_branch:
        description: "Select KSU branch"
        required: true
        type: choice
        options:
        - Stable
        - Dev
        - Other
        default: Stable
      version:
        description: 'Custom version name (e.g., characters after 5.10.198 / leave blank to use default version number)'
        required: false
        type: string
        default: ${{ env.DEFAULT_KERNEL_VERSION }}
      build_time:
        description: 'Set build time of kernel (e.g. Sat Jun 07 14:29:29 CST 2025)'
        required: false
        type: string
        default: ${{ env.DEFAULT_KERNEL_BUILD_TIME }}
      use_zram:
        description: 'Enable more ZRAM algorithms?'
        required: true
        type: boolean
        default: false
      use_kpm:
        description: 'Enable KPM functionality?'
        required: true
        type: boolean
        default: true
      use_bbg:
        description: "Enable Kernel-level blocking of illegal writes to critical partitions/device nodes (LSM)?"
        required: true
        type: boolean
        default: true
      use_hymo_fs:
        description: 'Enable HymoFS?'
        required: true
        type: boolean
        default: false


jobs:
  build-kernel:
    strategy:
      fail-fast: false
      matrix:
        include:
          - sub_level: "118"
            os_patch_level: "2025-01"
    uses: ./.github/workflows/build-kernel.yml
    secrets: inherit
    with:
      android_version: "android14"
      kernel_version: "6.1"
      sub_level: ${{ matrix.sub_level }}
      os_patch_level: ${{ matrix.os_patch_level }}
      kernelsu_variant: ${{ inputs.kernelsu_variant }}
      kernelsu_branch: ${{ inputs.kernelsu_branch }}
      version: ${{ inputs.version }}
      build_time: ${{ inputs.build_time }}
      use_zram: ${{ inputs.use_zram }}
      use_kpm: ${{ inputs.use_kpm }}
      use_bbg: ${{ inputs.use_bbg }}
      use_hymo_fs: ${{ inputs.use_hymo_fs }}
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    needs:
      - build-kernel
    env:
      REPO_OWNER: ${{ github.repository_owner }}
      REPO_NAME: ${{ github.event.repository.name }}
      GITHUB_TOKEN: ${{ secrets.MY_GITHUB_TOKEN }}
      INITIAL_RELEASE_NOTES: |
        This release includes **${{ inputs.kernelsu_variant == 'Next' && 'KernelSU-' || '' }}${{ inputs.kernelsu_variant }}**
        
        Features:
        -> ${{ inputs.kernelsu_variant == 'Next' && 'KernelSU-' || '' }}${{ inputs.kernelsu_variant }}-${{ inputs.kernelsu_branch }}
        -> SUSFS à¶ž v2.0.0
        -> Manual Syscall Hooks for better hiding
        -> Magic Mount Support
        -> Simple hiding for LineageOS detection
        -> Futile hiding for jit-zygote-cache detection
        -> Wireguard Support
        -> BBR Support
        ${{ inputs.use_bbg && '-> BBG Support' || '' }}
        -> BBG ${{ inputs.use_bbg && 'supported' || 'not supported' }}
        ${{ inputs.use_kpm && '-> KPM Support' || '' }}
        -> **LZ4KD&ONEPLUS_LZ4K** ${{ inputs.use_zram && 'supported' || 'not supported' }}
        
        <details>
        <summary>Notes:</summary>
        - -> In SUS SU Mode 2, it will show as disabled or incompatible, the reason is that non-kprobe hooks were used (when compiling the kernel), and non-kprobe hooks are no longer needed!
        - -> In the latest version of susfs, flashing AK3 compressed package with Kernel Flasher will brick your device, try [Horizon Kernel Flasher]\(https://github.com/libxzr/HorizonKernelFlasher)!
        </details>
        
        Modules:
        -> https://github.com/sidex15/ksu_module_susfs
    steps:
      - name: Conditional Release Check
        id: release_check
        if: ${{ inputs.make_release }}
        run: echo "Release conditions met. Proceeding with release."
        
      - name: Checkout code
        if: ${{ steps.release_check.outcome == 'success' }}
        uses: actions/checkout@v4
        
      - name: Install GitHub CLI
        if: ${{ steps.release_check.outcome == 'success' }}
        run: |
          type -p gh >/dev/null || {
            sudo apt update
            sudo apt install -y gh
          }
          
      - name: Generate and Create New Tag (Atomic)
        if: ${{ steps.release_check.outcome == 'success' }}
        env:
          GITHUB_TOKEN: ${{ secrets.MY_GITHUB_TOKEN }}
        run: |
          set -e

          BASE_VERSION="v2.0.0"
          
          # Fetch all existing tags using git ls-remote
          EXISTING_TAGS=$(git ls-remote --tags https://github.com/$REPO_OWNER/$REPO_NAME.git | awk '{print $2}' | sed 's/refs\/tags\///' || true)

          # Find highest revision number for this base version
          MAX_REVISION=0
          while IFS= read -r tag; do
            if [[ "$tag" =~ ^$BASE_VERSION-r([0-9]+)$ ]]; then
              revision="${BASH_REMATCH[1]}"
              if (( revision > MAX_REVISION )); then
                MAX_REVISION=$revision
              fi
            fi
          done <<< "$EXISTING_TAGS"

          # Generate new revision number and tag
          NEW_REVISION=$((MAX_REVISION + 1))
          NEW_TAG="$BASE_VERSION-r$NEW_REVISION"

          echo "New tag generated: $NEW_TAG"
          echo "NEW_TAG=$NEW_TAG" >> $GITHUB_ENV

          # Optional: Check if tag already exists in remote
          if git ls-remote --exit-code --tags origin "$NEW_TAG" > /dev/null 2>&1; then
            echo "::error::Tag '$NEW_TAG' already exists in remote repository. Aborting."
            exit 1
          fi

          # Configure Git
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

          # Create and push new tag
          git tag -a "$NEW_TAG" -m "Release $NEW_TAG"
          git push origin "$NEW_TAG"

          echo "Tag $NEW_TAG created and pushed successfully" 
          
      - name: Set KSU Version and Release Name
        if: ${{ steps.release_check.outcome == 'success' }}
        run: |
          # Use temporary directories to avoid conflicts
          if [ "${{ inputs.kernelsu_variant }}" = "Next" ]; then
            echo "Processing Next variant"
            git clone https://github.com/KernelSU-Next/KernelSU-Next.git ksu-next-tmp
            cd ksu-next-tmp
            KSU_GIT_VERSION=$(git rev-list --count HEAD)
            KSU_VERSION=$((10000 + KSU_GIT_VERSION + 200))
            echo "Next version: $KSU_VERSION"
            cd ..
            rm -rf ksu-next-tmp
            echo "RELEASE_NAME=\"GKI Kernel: KernelSU-Next ($KSU_VERSION) & SUSFS v2.0.0\"" >> $GITHUB_ENV
            
          elif [ "${{ inputs.kernelsu_variant }}" = "SukiSU" ]; then
            echo "Processing SukiSU variant"
            git clone https://github.com/SukiSU-Ultra/SukiSU-Ultra.git suki-tmp
            cd suki-tmp
            KSU_GIT_VERSION=$(git rev-list --count HEAD)
            KSU_VERSION=$((10000 + KSU_GIT_VERSION + 700))
            echo "SukiSU version: $KSU_VERSION"
            cd ..
            rm -rf suki-tmp
            echo "RELEASE_NAME=\"GKI Kernel: SukiSU ($KSU_VERSION) & SUSFS v2.0.0\"" >> $GITHUB_ENV
            
          else
            echo "Using default naming for variant: ${{ inputs.kernelsu_variant }}"
            echo "RELEASE_NAME=\"GKI Kernel: ${{ inputs.kernelsu_variant }} & SUSFS v2.0.0\"" >> $GITHUB_ENV
          fi
          
      - name: Fetch KSU and SUSFS Commit Info
        id: build_notes
        if: ${{ steps.release_check.outcome == 'success' }}
        run: |
          # Handle 'Other' branch selection
          if [[ "${{ inputs.kernelsu_branch }}" == "Other" ]]; then
            echo "Using custom branch selection"
            if [[ "${{ inputs.kernelsu_variant }}" == "Official" ]]; then
              KSU_BRANCH="main"
            elif [[ "${{ inputs.kernelsu_variant }}" == "Next" ]]; then
              KSU_BRANCH="next"
            else
              KSU_BRANCH="main"  # Default for MKSU/SukiSU
            fi
          elif [[ "${{ inputs.kernelsu_branch }}" == "Dev" || "${{ inputs.kernelsu_variant }}" == "MKSU" || "${{ inputs.kernelsu_variant }}" == "SukiSU" ]]; then
            if [[ "${{ inputs.kernelsu_variant }}" == "Official" || "${{ inputs.kernelsu_variant }}" == "MKSU" || "${{ inputs.kernelsu_variant }}" == "SukiSU" ]]; then
              KSU_BRANCH="main"
            elif [[ "${{ inputs.kernelsu_variant }}" == "Next" ]]; then
              KSU_BRANCH="next"
            fi
          elif [[ "${{ inputs.kernelsu_branch }}" == "Stable" && "${{ inputs.kernelsu_variant }}" != "MKSU" ]]; then
            KSU_REPO_URL=""
            if [ "${{ inputs.kernelsu_variant }}" == "Official" ]; then
              KSU_REPO_URL="https://github.com/tiann/KernelSU.git"
            elif [ "${{ inputs.kernelsu_variant }}" == "Next" ]; then
              KSU_REPO_URL="https://github.com/KernelSU-Next/KernelSU-Next.git"
            elif [ "${{ inputs.kernelsu_variant }}" == "SukiSU" ]; then
              KSU_REPO_URL="https://github.com/ShirkNeko/KernelSU.git"
            fi
            
            if [ -n "$KSU_REPO_URL" ]; then
              TAG=$(git ls-remote --tags --sort=-v:refname "$KSU_REPO_URL" | grep -o 'refs/tags/.*' | cut -d'/' -f3 | head -n1)
              KSU_BRANCH="${TAG:-UNKNOWN_TAG}"
            else
              KSU_BRANCH="main"
            fi
          fi
          
          echo "KSU_BRANCH=$KSU_BRANCH" >> $GITHUB_ENV
          
          KSU_REPO_URL=""
          KSU_REPO_URL2=""
          if [ "${{ inputs.kernelsu_variant }}" == "Official" ]; then
            KSU_REPO_URL="https://github.com/tiann/KernelSU.git"
            KSU_REPO_URL2="tiann/KernelSU"
          elif [ "${{ inputs.kernelsu_variant }}" == "Next" ]; then
            KSU_REPO_URL="https://github.com/KernelSU-Next/KernelSU-Next.git"
            KSU_REPO_URL2="KernelSU-Next/KernelSU-Next"
          elif [ "${{ inputs.kernelsu_variant }}" == "MKSU" ]; then
            KSU_REPO_URL="https://github.com/5ec1cff/KernelSU.git"
            KSU_REPO_URL2="5ec1cff/KernelSU"
          elif [ "${{ inputs.kernelsu_variant }}" == "SukiSU" ]; then
            KSU_REPO_URL="https://github.com/ShirkNeko/KernelSU.git"
            KSU_REPO_URL2="ShirkNeko/KernelSU"
          else
            echo "Warning: Unknown KernelSU variant selected. Defaulting to Official for URL generation."
            KSU_REPO_URL="https://github.com/tiann/KernelSU.git"
            KSU_REPO_URL2="tiann/KernelSU"
          fi
          
          KSU_REF=""
          KSU_URL=""
          if [[ "${{ inputs.kernelsu_branch }}" == "Stable" && "${{ inputs.kernelsu_variant }}" != "MKSU" ]]; then
            TAG=$(git ls-remote --tags --sort=-v:refname "$KSU_REPO_URL" | grep -o 'refs/tags/.*' | cut -d'/' -f3 | head -n1)
            KSU_REF="${TAG:-UNKNOWN_TAG}"
            KSU_URL="https://github.com/$KSU_REPO_URL2/releases/tag/$KSU_REF"
          elif [[ -n "$KSU_BRANCH" ]]; then
            COMMIT_HASH=$(git ls-remote "$KSU_REPO_URL" "refs/heads/$KSU_BRANCH" | awk '{ print $1 }')
            KSU_REF="${COMMIT_HASH:-UNKNOWN_COMMIT}"
            KSU_URL="https://github.com/$KSU_REPO_URL2/commit/$KSU_REF"
          else
            echo "Error: KSU branch could not be determined. KSU commit information will be incomplete." >&2
          fi
          
          FINAL_RELEASE_NOTES="${{ env.INITIAL_RELEASE_NOTES }}"
          
          FINAL_RELEASE_NOTES+="\n\nLTO: thin"
          FINAL_RELEASE_NOTES+="\n\n<details>"
          FINAL_RELEASE_NOTES+="\n<summary>Commit Information</summary>"
          FINAL_RELEASE_NOTES+="\n\nCommit hashes and links (the following commits refer to the progress of KSU or SUSFS at the time of this compilation):"
          FINAL_RELEASE_NOTES+="\n- **KernelSU is ${{ inputs.kernelsu_variant }}-${KSU_BRANCH}** (Commit): [${KSU_REF}](${KSU_URL})"
          FINAL_RELEASE_NOTES+="\n- **SUSFS4KSU** (Commit):"
          
          GITLAB_OWNER="simonpunk"
          GITLAB_REPO="susfs4ksu"
          
          declare -A BRANCH_MAP=(
            ["a14-6.1"]="gki-android14-6.1"
          )
          
          declare -a KERNELS_TO_FETCH_SUSFS
          KERNELS_TO_FETCH_SUSFS+=("a14-6.1")

          mapfile -t SORTED_KERNELS < <(printf '%s\n' "${KERNELS_TO_FETCH_SUSFS[@]}" | sort)
          KERNELS_TO_FETCH_SUSFS=("${SORTED_KERNELS[@]}")
          
          for kernel_id in "${KERNELS_TO_FETCH_SUSFS[@]}"; do
            susfs_branch_name="${BRANCH_MAP[$kernel_id]}"
            if [[ -n "$susfs_branch_name" ]]; then
              SUSFS_COMMIT_HASH=$(git ls-remote "https://gitlab.com/$GITLAB_OWNER/$GITLAB_REPO.git" "refs/heads/$susfs_branch_name" | awk '{ print $1 }')
              SUSFS_COMMIT_HASH="${SUSFS_COMMIT_HASH:-UNKNOWN_COMMIT}"
              SUSFS_COMMIT_URL="https://gitlab.com/$GITLAB_OWNER/$GITLAB_REPO/-/commit/$SUSFS_COMMIT_HASH"
              FINAL_RELEASE_NOTES+="\n - ${kernel_id}: [${SUSFS_COMMIT_HASH}](${SUSFS_COMMIT_URL})"
            else
              echo "Warning: SUSFS branch name not found for kernel ID: $kernel_id. Cannot fetch commit info." >&2
            fi
          done
          
          FINAL_RELEASE_NOTES+="\n\n</details>"
          
          echo "FULL_RELEASE_NOTES<<EOF" >> $GITHUB_ENV
          echo -e "$FINAL_RELEASE_NOTES" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
          
      - name: Download Artifacts
        if: ${{ steps.release_check.outcome == 'success' }}
        uses: actions/download-artifact@v4
        with:
          path: release-artifacts-${{ github.run_id }}
          
      - name: Prepare Artifacts for Upload
        if: ${{ steps.release_check.outcome == 'success' }}
        run: |
          # Create a new directory for release assets
          mkdir -p release-assets
          
          # Find and copy all artifacts to a flat directory structure
          find ./release-artifacts-${{ github.run_id }} -type f -exec cp -v {} ./release-assets \;
          
          # Generate checksums
          cd release-assets
          sha256sum * > SHA256SUMS.txt
          cd ..
          
          echo "Artifacts prepared for upload:"
          ls -lh ./release-assets
          
      - name: Create GitHub Release
        if: ${{ steps.release_check.outcome == 'success' }}
        uses: actions/create-release@v1
        with:
          tag_name: ${{ env.NEW_TAG }}
          prerelease: true
          release_name: ${{ env.RELEASE_NAME }}
          body: ${{ env.FULL_RELEASE_NOTES }}
        env:
          GITHUB_TOKEN: ${{ secrets.MY_GITHUB_TOKEN }}
          
      - name: Upload Release Assets
        if: ${{ steps.release_check.outcome == 'success' }}
        env:
          GH_TOKEN: ${{ secrets.MY_GITHUB_TOKEN }}
        run: |
          echo "Uploading release assets..."
          
          # Upload all files in the release-assets directory
          for file in ./release-assets/*; do
            echo "Uploading $file"
            gh release upload "${{ env.NEW_TAG }}" "$file" || echo "Failed to upload $file"
          done
          
          echo "Upload completed!"
          
      - name: Verify Uploaded Assets
        if: ${{ steps.release_check.outcome == 'success' }}
        run: |
          echo "Uploaded assets:"
          gh release view "${{ env.NEW_TAG }}" --json assets -q '.assets[].name'
          